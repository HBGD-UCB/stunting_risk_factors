---
title: "Risk Factors of Stunting"
author: "Jeremy Coyle"
date: "5/24/2018"
output: 
  html_document:
    keep_md: TRUE
    self_contained: true
---

```{r setup, include=FALSE}
library(data.table)
library(metafor)
library(ggplot2)
knitr::opts_chunk$set(echo = FALSE)

# load data
load("../stunting_prevalance_results.rdata")
results <- setDT(results)
```

# Pooled Results

## Prevlanace of Stunting

```{r do_pooling}

# extract RR results
rr_results <- results[type=="RR"]
one_result <- rr_results[intervention_level==">51"&agecat=="3 months"]
pool_rr <- function(one_result){
  # get pooled estimate
  pooled <- try({rma(yi=one_result$untransformed_estimate, 
                sei=one_result$untransformed_se, 
                method="ML")})
  
  # make new pooled result row
  pooled_result <- one_result[1,]
  pooled_result[,studyid:="pooled"]
  pooled_result[,strata_label:=NULL]

  if(!inherits(pooled,"try-error")){
    pooled_result[,untransformed_estimate:=pooled$beta]
    pooled_result[,untransformed_se:=pooled$se]
    pooled_result[,estimate:=exp(pooled$beta)]
    pooled_result[,ci_lower:=exp(pooled$ci.lb)]
    pooled_result[,ci_upper:=exp(pooled$ci.ub)]
  } else {
    pooled_result[,untransformed_estimate:=NA_real_]
    pooled_result[,untransformed_se:=NA_real_]
    pooled_result[,estimate:=NA_real_]
    pooled_result[,ci_lower:=NA_real_]
    pooled_result[,ci_upper:=NA_real_]
  }
  return(pooled_result)
}

pooled_rrs <- rr_results[,pool_rr(.SD), 
                          by=list(agecat,intervention_variable, intervention_level)]

agecat_levels <- c("Birth", "3 months", "6 months", 
                   "9 months", "12 months", "18 months", 
                   "24 months")
pooled_rrs[,agecat:=factor(agecat, levels=agecat_levels)]
pooled_rrs[,sig:=1<ci_lower|ci_upper<1]
pooled_rrs[,sig_alpha:=0.3+0.7*sig]
# set plot bounds so plots are comparable
# todo: bounds in data are currently silly so these are set manually
xmin <- 0
xmax <- 10
```

```{r plot_pooled,results="asis", warning=FALSE}
intervention_variables <- unique(pooled_rrs$intervention_variable)
for(rf in intervention_variables) {
  cat("  \n###",  rf, "  \n")
  
  one_pooled_rr <- pooled_rrs[intervention_variable==rf]

  cat("reference level:",  one_pooled_rr$baseline_level[1], "  \n")
  dodge=position_dodge(width=-0.8)
  rrplot <- ggplot(one_pooled_rr, 
                   aes(y=estimate,ymin=ci_lower,ymax=ci_upper,
                       x=intervention_level, color=agecat))+
    geom_point(aes(alpha=sig_alpha), size=2,position=dodge)+
    geom_errorbar(aes(alpha=sig_alpha*0.7),width=0,size=2,position=dodge)+
    geom_hline(aes(yintercept=1),linetype="dashed")+theme_bw()+xlab("")+ylab("Relative Risk")+scale_color_discrete("Age Cohort")+coord_flip()+scale_alpha_continuous(guide=FALSE,limits=c(0,1))
  print(rrplot)
  cat("  \n")
}
```

## Appendix 1 - Risk Factor Forest Plots
```{r forest}
# rr forest plots
```
